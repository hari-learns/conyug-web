rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Supporters collection - for landing page form submissions
    match /supporters/{document=**} {
      // Allow anyone to create or update their supporter record
      allow create, update: if request.resource.data.size() <= 6 // small payload
                    && (
                      // Must have either email OR phone
                      (request.resource.data.keys().hasAll(['email', 'contactType', 'timestamp', 'source'])
                       && request.resource.data.contactType == 'email'
                       && request.resource.data.email is string
                       && request.resource.data.email.size() > 0
                       && request.resource.data.email.size() <= 100
                       && request.resource.data.email.matches('.*@.*'))
                      ||
                      (request.resource.data.keys().hasAll(['phone', 'contactType', 'timestamp', 'source'])
                       && request.resource.data.contactType == 'phone'
                       && request.resource.data.phone is string
                       && request.resource.data.phone.matches('^[0-9]{10}$'))
                    )
                    && request.resource.data.source == 'landing-page';

      // No public reads
      allow read: if false;

      // Prevent deletes
      allow delete: if false;
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
